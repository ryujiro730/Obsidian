# 全体設計（完成版 v1）

## A. 変えない核（設計の背骨）

- **Aha体験：公開→フォーク→登録→即実行**はそのまま死守（≤90秒）。これが差別化の中心。
    
- **再現性**は `code_hash / dataset_hash / seed` を runs に保存して完全一致。
    
- **課金ライン**：公開は無料・非公開/並列/高速でペイウォール。プラン設計も踏襲。
    

## B. 技術スタック（自作サーバー寄り・長期運用対応）

- フロント：**Next.js 14 (App Router, ISR/OG)**
    
- API：**FastAPI + Uvicorn**
    
- 非同期：**Celery + Redis**（free / paid / priority のキュー分離）
    
- DB：**Postgres 16**（自前; Docker 永続化）
    
- オブジェクトストレージ：**MinIO**（S3互換; 将来CDNのみR2/CloudFrontレイヤで吸収）
    
- 課金：**Stripe**（据え置き）
    
- 観測：**Sentry**（アプリ）、**OpenTelemetry → Loki/Tempo/Prometheus**（段階導入）
    
- 配信：**Cloudflare (CDN/WAF)** + **Traefik/Nginx**（L7リバプロ）
    
- デプロイ：開発は **Docker Compose** / 本番は **1台VM→(需要次第で)Kubernetes or ECS**
    
- 秘密管理：dotenv（Dev）→ **1Password/Cloud Secret Manager**（本番）
    

> 目的：**BaaSの従量爆発を回避**し、**計算・データ量の伸びにリニア対応**する。

## C. アーキテクチャ（最終案・概略）
```less
[Next.js] --HTTPS/JWT--> [FastAPI API]
                         |  \
                         |   \-- enqueue --> [Redis] --> [Celery Workers]
                         |                                   |
                         |                            (Backtest, 指標計算)
                         v                                   |
                 [Postgres: users/strategies/runs/quota]     |
                         |                                   v
                         |------------------------------> [MinIO: data/strategies/results/og]
                                            (OG/Embed/静的配信はCDNで前段キャッシュ)

```
- **Queue分離**：`celery -Q free,paid,priority`（無料はスループットの ≤10% を保証）
    
- **Idempotency**：`/api/run` は `Idempotency-Key`（ヘッダ）を必須化・二重実行防止
    
- **Correlation-ID** を全レイヤに貫通（デバッグ/監査）
    

## D. データモデル（v1固定）

- `users` / `user_quota (compute_left, plan)` / `strategies` / `runs`（現状通り、R2→MinIOに命名置換）
    
- オブジェクト：`data/{dataset_hash}.(csv|parquet)`, `strategies/{sid}.json`, `results/{sid}/{run_id}.json|parquet`, `og/{sid}.png`（**R2表記→MinIO表記に統一**）
    

## E. APIサーフェス（最小で回る完成形）

- `POST /api/run`：
    
    - 入力：`sid, seed, code_hash, dataset_hash, idempotency_key`
        
    - 処理：**quotaチェック → runs.insert(status='queued') → send_task**
        
    - 出力：`{ run_id }`（202）
        
- `GET /api/report/{sid}`：最新1件（**未完了でも status を返す**）
    
- `GET /api/run/{run_id}`：単一実行の状態・指標（Frontのポーリング用）
    
- `POST /api/strategies/publish` / `POST /api/strategies/fork`：公開→フォーク→即実行の導線をAPIで担保
    
- **Rate Limit**：`/fork` 10/min/ip、`/run` 30/min/user（プラン別; 今のポリシー踏襲）
    

## F. 非機能（NFR）とSLO

- **SLO**：`enqueue p95 < 2s / run_start p95 < 10s / small-run p95 < 30s / 稼働率 99.9%`（現行定義を自前運用前提で維持）
    
- **セキュリティ**：短寿命JWT、CSP、Origin Allowlist、embed token（既定踏襲）
    
- **再現性**：同条件完全一致・署名付き再現JSON（結果とともにMinIOへ）
    

## G. コスト・運用設計

- **固定費中心**（VM×少数台 + オブジェクトストレージのボリューム）
    
- **有料優先SLO**：freeキュー飽和でも paid/priority は遅延しない（ワーカーをQueue別に固定割当）
    
- **バックアップ**：Postgres（WAL + 夜間スナップショット）、MinIO（バージョニング + 週次フル）
    

## H. ロードマップ（出荷までの段階）

- **S1（今）**：公開レポ/OG/JWT、フォーク自動実行、キュー分離、最小events（DB内）で出荷判定まで通す。
    
- **S2**：埋め込み、非公開=有料、Stripe新価格、領収書PDF（既定踏襲）
    
- **S3**：ギャラリー、Referral、週次ダイジェスト（簡易）
    
- **S4**：Programmatic SEO、A/B、SLOダッシュボード、データ品質検知（ClickHouse移行検討）

## 10. 課金・価格（運用詳細）

**プラン表**は別表（改定反映）を正とする。ここでは**値段管理（料金運用）**の仕様を定義する。

### 10.1 Stripe セットアップ（Products/Prices）

- **Products**
    
    - `starter`, `pro`, `elite`（サブスク）
        
    - `speed_pack`（月額アドオン：優先/高速キュー）
        
    - `credit_pack_1000`（都度課金：1,000回=¥1,500）
        
- **Prices（例）**
    
    - `starter_m_jpy`, `starter_y_jpy`（年払いは -16%）
        
    - `pro_m_jpy`, `pro_y_jpy`
        
    - `elite_q_jpy`, `elite_y_jpy`（四半期/年）
        
    - `speed_pack_m_jpy`
        
    - `credit_pack_1000_oneoff_jpy`
        
- **Webhooks（必須）**：`checkout.session.completed`, `invoice.paid`, `customer.subscription.updated`, `invoice.payment_failed`, `charge.refunded`。受信時に**quota/権限を即時反映**。
    

### 10.2 クレジット/超過の計測モデル

- **日次クレジット**（Free/Starter/Pro）：`user_quota.compute_left` を日次リセット（UTC 00:00）。MVP実装に合流。
    
- **Elite 同梱分**：`included_runs_monthly = 2000`。当月の **実行数**が同梱分を超えたら、**overage = (実行数 - included)** をカウントし、**¥0.02/回**で月末に課金（Invoice Itemを生成）。
    
- **アドオン**
    
    - `speed_pack`：優先/高速キューの使用権（スロット拡張 & 優先度タグ付与）。
        
    - `credit_pack_1000`：1,000回分を**使用残高（ledger）**に加算。
        
- **保存上限**：プラン表の保存件数に達した場合、最古から自動ローテーション（非公開は有料）。
    

**推奨テーブル（抜粋 SQL）**：
```sql
-- 現行 user_quota を拡張
create table if not exists user_quota(
  user_id uuid primary key,
  plan text not null default 'free',
  compute_left int not null default 3,     -- 日次クレジット
  credit_balance int not null default 0,   -- 都度購入クレジット残
  included_monthly int not null default 0, -- 当月同梱使用数(Elite)
  billing_period_start date,               -- 当月開始
  updated_at timestamptz default now()
);

-- 実行の台帳（監査/課金根拠）
create table if not exists usage_ledger(
  id bigserial primary key,
  user_id uuid not null,
  run_id uuid,
  kind text not null,            -- 'run'|'overage'|'credit_consume' etc.
  amount int not null default 1, -- 単位=回
  note text,
  created_at timestamptz default now()
);

```
**課金消費ロジック（/api/run 前段）**（擬似コード）：
```python
def charge_check(user, plan, speed_pack=False):
    # 1) Elite：同梱2000/月 → 超過は後課金
    if plan == 'elite':
        if month_has_changed(user): reset_included_monthly()
        increment_included_monthly(user)  # usage_ledgerへ記録
        if included_monthly(user) > 2000:
            record_overage(user, 1)  # ¥0.02/回、月末にInvoice Item化
        return allow(queue='priority' if speed_pack else 'paid')

    # 2) Starter/Pro/Free：日次 compute_left → 0なら credit_balance → それも0なら拒否
    if compute_left(user) > 0:
        decrement_compute_left(user); ledger('run'); 
        return allow(queue='free' if plan=='free' else 'paid')

    if credit_balance(user) > 0:
        decrement_credit(user, 1); ledger('credit_consume');
        return allow(queue='paid')

    return reject(402, 'NO_CREDIT')  # フロントで課金導線へ

```

### 10.3 請求・返金・失敗時の運用

- **グランドファザー**：既存ユーザーは改定後も旧価格維持（任意で「今すぐ移行」導線）。
    
- **7日返金**：`charge.refunded` 受領時に `credit_balance` を差し戻し／権限を巻き戻す。
    
- **支払い失敗（Dunning）**：3回再試行 → 7日後に **Freeへ降格**、非公開は**ロック**、保存は猶予30日。
    
- **領収書PDF/税**：Stripeの自動発行＋JP/US税をStripe Taxで処理。
    

### 10.4 通貨/為替

- 価格の**主通貨=JPY**。US向けは **USD表示**（為替レート方針は未決→S1で決定）。
    
- Rateは月次固定の社内TTS（例：`USD=JPY/140`）か Stripeの多通貨を採用。
    

### 10.5 プロモ/クーポン

- **紹介（Referral）**：決済完了で紹介者に**Computeクレジット付与**（台帳に記録）。不正は決済後ボーナス・端末FPで抑止。
    
- **割引**：初月20%オフクーポン、年払い-16%は価格に内包。
    
- **キャンペーン**：A/Bで価格弾力性を検証（see 11. KPI）。
    

### 10.6 プラン別スロット/並列

- **free|paid|priority** のキュー分離。有料が常にSLOを維持できる配分（無料≤10%）。運用規約として固定。
    

---

## 17. 集客 / GTM / 成長ループ（完成版）

**方針**：コア導線（公開→フォーク→登録→即実行 ≤90秒）を**拡散の起点**にするPLG。K係数0.25–0.40を初期目標。

### 17.1 チャンネル設計（優先度順）

1. **Programmatic SEO（スケール軸）**
    
    - 自動生成ページ：`/backtest/{pair}/{tf}/{strategy}`（結果要約+OG）。
        
    - canonical, sitemap, 内部リンク最適化、Noindex制御を徹底。
        
    - まずは **主要6通貨 × 3タイムフレーム × 人気戦略10** を量産。
        
2. **共有/埋め込み（無料で広がる導線）**
    
    - 公開レポに **「コピーして検証（無料）」** を大ボタンで配置。
        
    - 埋め込みウィジェット（ブログ/YouTube/Note）で外部露出→フォーク動線。
        
3. **クリエイター/EA販売者タイアップ**
    
    - 収益分配 or クーポン＋**埋め込み**で教材/販売ページに導線。ReferralはComputeクレジット報酬。
        
4. **ソーシャル（X/YouTube/Discord）**
    
    - OG画像に **PF/勝率/MaxDD/Trades** を入れ、クリックでレポ→フォークへ。週1ハイライト（勝率やPFランキング）。
        
5. **メール/ライフサイクル**
    
    - Onboarding：`signup → first_run` を3通で支援（テンプレ戦略を1クリック実行）。
        
    - リテンション：**週次ダイジェスト**（自分の戦略 vs コミュ中央値）。
        
6. **有料広告（後回し）**
    
    - SEO/共有でK係数が見えた後、Pro/Elite向けに限定的に運用。
        

### 17.2 ファネルとKPI（既存KPIに紐付け）

- **A1**：サインアップ→初回実行 ≤90秒（到達≥70%）
    
- **P1**：公開率≥25% / **F1**：公開→フォーク≥20% / **K係数 0.25–0.40**
    
- **CVR**：フォーク体験者→有料≥10%（全体≥5%）
    
- **SLO**：p95基準/失敗率≤1%（有料は常時維持）
    

**イベント（最小）**：`view_report`, `click_share`, `click_fork_from_report`, `signup_from_fork`, `fork_success`, `run_started`, `run_finished`, `checkout_started`, `checkout_paid`, `embed_view`（当面はDB、将来ClickHouseに移行）。

### 17.3 90日実行計画

- **Week 0–2**：公開レポ/OG/フォーク即実行のAha体験を磨く（≤90秒）。12本のテンプレ戦略+ダミーデータを整備。
    
- **Week 3–4**：Programmatic SEO（60–100ページ）公開。埋め込みβを配布。
    
- **Week 5–8**：YouTube/Noteタイアップ2–3件、Referral開始。
    
- **Week 9–12**：ギャラリー簡易版と週次ダイジェストリリース、価格A/B（Starter, Pro）。
    

### 17.4 リスクと対処（成長面）

- **虚偽パフォーマンス**：署名付き再現JSONと検証モードで担保。
    
- **Compute暴発**：クレ前払い・Fair Use・上限アラートで抑制。
    
- **Referral不正**：決済後ボーナス/端末指紋/遅延計測。
    

---

# 実装メモ（API/Workerへの差分）

- **/api/run** に課金ガードを実装
    
    - `Idempotency-Key` 必須（同一キーは直近run_idを返す）
        
    - **プラン判定**→**compute_left / credit / included_monthly** の順で消費可否判断 → **キュー選択**（`free|paid|priority`）を付与。
        
- **定期ジョブ**
    
    - `daily@00:00 UTC`：`compute_left` をプラン既定値にリセット
        
    - `monthly@period_start`：Eliteの `included_monthly=0` リセット、前月overageをStripeにInvoice Item化
        
- **キュー配分（SLO維持）**
    
    - free ≤ 10% スロット固定、paid を既定、speed/elite は priority で最優先。