# 遺伝子構造.md

## 🎯 目的
DEAP進化戦略で使用する「遺伝子」の定義とその設計ルールを記述する。

---

## 🧬 遺伝子構造（FEATUREごとのしきい値＋使用フラグ）

- 1つの特徴量 = `[threshold (float), use_flag (0 or 1)]`
- 1戦略 = `特徴量数 × 2` の遺伝子長をもつ list

### 例：個体 = [2.1, 1, 0.5, 0, 1.8, 1, -0.7, 1]  
→ 意味：

- zscore_20 > 2.1（使用する）
    
- volume_energy → 使用しない（0）
    
- momentum_10 > 1.8（使用する）
    
- velocity > -0.7（使用する）
    


from deap import base, creator, tools
import random

# 遺伝子長を定義（例：4つの特徴量 × 閾値と使用有無）
FEATURES = ["zscore_20", "volume_energy", "momentum_10", "velocity"]

def generate_individual():
    individual = []
    for feat in FEATURES:
        threshold = random.uniform(-3.0, 3.0)  # 閾値（連続変数）
        use_flag = random.randint(0, 1)        # 使用有無（バイナリ）
        individual += [threshold, use_flag]
    return individual

# 例: 個体 [2.1, 1, 0.5, 0, 1.8, 1, -0.7, 1]
# 意味:
# zscore_20 > 2.1（使用する）
# volume_energy → 使用しない（フラグ0）
# momentum_10 > 1.8（使用する）
# velocity > -0.7（使用する）



## 🎯 DEAP登録（Fitness & 個体型）

creator.create("FitnessMulti", base.Fitness, weights=(1.0, 1.0, -0.5))  # 勝率, RR比, MDD
creator.create("Individual", list, fitness=creator.FitnessMulti)

# 🔧 toolbox登録
toolbox = base.Toolbox()
toolbox.register("individual", tools.initIterate, creator.Individual, generate_individual)
toolbox.register("population", tools.initRepeat, list, toolbox.individual)
toolbox.register("mate", tools.cxTwoPoint)
toolbox.register("mutate", tools.mutGaussian, mu=0, sigma=0.5, indpb=0.2)
toolbox.register("select", tools.selNSGA2)  # 多目的最適化


## 🔍 評価関数の接続
def evaluate_strategy(individual):
    # 特徴量ごとの閾値と使用有無を分解
    rules = []
    for i, feat in enumerate(FEATURES):
        threshold = individual[i * 2]
        use_flag = individual[i * 2 + 1]
        if use_flag:
            rules.append((feat, threshold))
    
    # ここでルールを元にDataFrameにフィルターをかけ、勝率などを算出
    # → accuracy, rr, mdd を返す
    return accuracy, rr, mdd
