# データ設計.md

## 🎯 目的
15分足ベースの時系列価格データに対して、物理法則・統計指標・相関構造に基づく特徴量を一括生成し、戦略最適化に使用可能な形に整形することを目的とする。  
また、マクロ指標（VIX、COT、金利）との統合を含む。

---

## 📁 入力データ構成

### メイン価格データ
- **形式**：`15min.parquet`
- **格納先**：`/data/raw/merged/15min.parquet`
- **カラム例**（通貨ペア単位でプレフィックス付き）：
  - `usdjp_CandleOpen`, `usdjp_CandleClose`, `usdjp_CandleHigh`, `usdjp_CandleLow`, `usdjp_Volume`

## 🌍 通貨横断データ構成（Wide形式）

- すべての通貨ペアを1ファイルに統合
- 基準：`Datetime` インデックス
- 各列にプレフィックス付与：`{通貨コード}_{列名}`
- 例：`USDJPY_Close`, `EURUSD_Volume`, `GBPJPY_zscore_20` など

目的：
- 通貨間の同時監視・スクリーニングが可能
- XGBoost, DEAP, FAISS の全モデルで共通設計

---

## 🧮 特徴量生成構成

### 🔹 物理ベース特徴量（generate_physical_features）
- 入力：価格・出来高系列（Close, High, Low, Volume, Open）
- 出力：各プレフィックス単位で以下の特徴量が生成される：

| 特徴量名                              | 説明                       |
| --------------------------------- | ------------------------ |
| velocity, acceleration            | 1次・2次変化量（速度・加速度）         |
| kinetic_energy, volume_energy     | 運動エネルギーと出来高連動エネルギー       |
| momentum_{n}                      | 過去n本との価格差                |
| zscore_20, boltzmann_drift        | 20本z-scoreと指数変換ドリフト      |
| volatility_{n}                    | n本標準偏差                   |
| fib_center                        | フィボナッチ中心値（0.382）         |
| fft_peak_64                       | FFTスペクトルの最大周波数（周期性特徴）    |
| hurst_100                         | ハースト指数による分布特徴            |
| mean_diff_{n}                     | 移動平均との乖離                 |
| corr_close_volume_20              | 出来高と価格の20本相関             |
| skew_20, kurt_20                  | 歪度・尖度                    |
| position_in_range_20              | 過去20本レンジに対する現在位置         |
| total_energy_20                   | 速度の絶対値合計（20本）            |
| price_jump_flag                   | 異常値フラグ（100本平均×3倍）        |
| contrarian_pressure               | 逆張り圧力：`-zscore × volume` |
| positive/negative_streak          | 陽線/陰線連続数カウント             |
| upper/lower_wick                  | 上ヒゲ / 下ヒゲ                |
| candle_body                       | ローソク実体の長さ                |
| high_low_range / close_open_range | 高低差 / 終始差                |

---

### 🔹 コサイン類似特徴量（compute_cosine_features）

- 入力：各通貨の `Close`, `Open`, `High`, `Low` 列
- 出力：通貨間の価格パターン相関（10本）
- カラム例：
  - `cosine_usdjpy_Close_usdeur_Open_w10`

---

## 🔁 外部データ統合（merge_macro_features）

### ソースと仕様
| 指標 | ファイル | 再サンプリング | 備考 |
|------|----------|----------------|------|
| VIX  | `vix_data.parquet` | 日次 → 15分足 | 欠損は前方補完 |
| COT  | `cot_data.parquet` | 週次 → 15分足 | USDJPY用フィルタ前提 |
| 金利 | `fred_rates.parquet` | 日次 → 15分足 | 政策金利（FRED由来） |

- 全データは `Datetime` をキーにマージ
- 欠損は `ffill()` 前提

---

## 📦 出力ファイル構成

- 保存先：`/data/features/all_15min_features.parquet`
- フォーマット：Parquet
- 特徴量：物理・統計・マクロ統合済み

---

## 📝 備考
- 特徴量の選別・重要度評価はXGBoostで実施
- DEAP最適化対象パラメータはこの特徴量群の組み合わせに依存する
- プレフィックス処理により複数通貨に対応（例：`usdjp_`）

